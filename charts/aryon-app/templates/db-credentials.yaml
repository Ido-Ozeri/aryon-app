apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: postgres-password
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
  namespace: {{ include "app-bundle-helpers.namespace" . }}
spec:
  length: 32
  digits: 6
  symbols: 0
  noUpper: false
  allowRepeat: true
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.global.db_credentials_secret }}
  namespace: {{ include "app-bundle-helpers.namespace" . }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  refreshInterval: "0"
  target:
    name: {{ .Values.global.db_credentials_secret }}
    creationPolicy: Owner
    template:
      data:
        DB_HOST: {{ .Values.global.db_host }}
        DB_USER: {{ .Values.global.db_user }}
        DB_NAME: {{ .Values.global.db_name }}
        DB_PASSWORD: "{{ `{{ .password }}` }}"
        DB_PORT: "5432"
        # These satisfy the Postgres chart values;
        username: {{ .Values.global.db_user }}
        postgres-password: "{{ `{{ .password }}` }}"
        user-password: "{{ `{{ .password }}` }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: postgres-password
      rewrite:
        - regexp:
            source: "(.*)"
            target: "password"
